# Makefile for various platforms
# Execute using Build csh-script only!
# Used together with Perl scripts in SRC/SCRIPT 
# (C) 2005 Marat Khairoutdinov
#------------------------------------------------------------------
# uncomment to disable timers:
#
#NOTIMERS=-DDISABLE_TIMERS
#-----------------------------------------------------------------

SAM = SAM_$(ADV_DIR)_$(SGS_DIR)_$(RAD_DIR)_$(MICRO_DIR)

# Determine platform 
PLATFORM := $(shell uname -s)

#----------------------------------
# Apple Mac OS X (Darwin) (GNU compiler)
#

ifeq ($(PLATFORM),Darwin)

	INC_NETCDF := /opt/local/include
	LIB_NETCDF := /opt/local/include

	FF77 = mpif90-openmpi-mp -c -ffixed-form -ffixed-line-length-0
	FF90 = mpif90-openmpi-mp -c -ffree-form -ffree-line-length-0
	CC = gcc -c -DLINUX

	FFLAGS = -g -traceback -O3 -w -fallow-argument-mismatch
	FFLAGS += -I${INC_NETCDF}
	LD = mpif90-openmpi-mp
	LDFLAGS = -L${LIB_NETCDF} -lnetcdff

endif

#----------------------------------
# LEVANTE (Linux, OpenMPI)
#

ifeq ($(PLATFORM),Linux)

	ifeq ($(COMPIL_TYPE),INTEL)
		INC_NETCDF := /sw/spack-levante/netcdf-fortran-4.5.3-pvmcx6/include
		LIB_NETCDF := /sw/spack-levante/netcdf-fortran-4.5.3-pvmcx6/lib

		FF77 = mpifort -c -fixed -extend_source
		FF90 = mpifort -c
		CC = mpicc -c -DLINUX

		ifeq ($(DEBUG_FLAG),FALSE) then
		  # Optim mode compilation
		  FFLAGS = -Ofast -march=core-avx2
		else
		  # Debug mode compilation
		  #FFLAGS = -fpe0 -O0 -g -check all -traceback -debug all
		  FFLAGS = -fpe0 -O0 -g -traceback -debug all
		endif
		FFLAGS += -I${INC_NETCDF}
		LD = mpifort
		LDFLAGS = -L${LIB_NETCDF} -Wl,-rpath,${LIB_NETCDF} -lnetcdff
	else
		######### GNU

		INC_NETCDF := /groups/ocean/software/software/netcdf4-mpich/4.6.3/include
		LIB_NETCDF := /groups/ocean/software/software/netcdf4-mpich/4.6.3/lib

		FF77 = mpifort -c -ffixed-form -ffixed-line-length-0
		FF90 = mpifort -c -ffree-form -ffree-line-length-0
		CC = mpicc -c -DLINUX

		ifeq ($(DEBUG_FLAG),FALSE) then
		  # Optim mode compilation
		  FFLAGS = -Ofast
		else
		  # Debug mode compilation
		  FFLAGS = -fpe0 -O0 -g -check all -traceback -debug all
		endif
		FFLAGS += -I${INC_NETCDF}
		LD = mpifort
		LDFLAGS = -L${LIB_NETCDF} -lnetcdff
	endif

endif

#----------------------------------
#----------------------------------------------
# you dont need to edit below this line


#compute the search path
dirs := . $(shell cat Filepath)
VPATH    := $(foreach dir,$(dirs),$(wildcard $(dir))) 

.SUFFIXES:
.SUFFIXES: .f .f90 .c .o



all: $(SAM_DIR)/$(SAM)


SOURCES   := $(shell cat Srcfiles)

Depends: Srcfiles Filepath
	$(SAM_SRC)/SCRIPT/mkDepends Filepath Srcfiles > $@

Srcfiles: Filepath
	$(SAM_SRC)/SCRIPT/mkSrcfiles > $@

OBJS      := $(addsuffix .o, $(basename $(SOURCES))) 

$(SAM_DIR)/$(SAM): $(OBJS)
	$(LD) -o $@ $(OBJS) $(LDFLAGS)


.f90.o:
	${FF90}  ${FFLAGS} $<
.f.o:
	${FF77}  ${FFLAGS} $<
.c.o:
	${CC}  ${CFLAGS} -I$(SAM_SRC)/TIMING $(NOTIMERS) $<



include Depends


clean: 
	rm ./OBJ/*
